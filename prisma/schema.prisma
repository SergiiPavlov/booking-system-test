generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


enum UserRole {
  CLIENT
  BUSINESS
  ADMIN
}

enum AppointmentStatus {
  BOOKED
  CANCELED
}

model User {
  id           String   @id @default(uuid())
  role         UserRole
  name         String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clientAppointments   Appointment[] @relation("ClientAppointments")
  businessAppointments Appointment[] @relation("BusinessAppointments")

  workingHours BusinessWorkingHour[] @relation("BusinessWorkingHours")
  breaks       BusinessBreak[]       @relation("BusinessBreaks")

  /// Store the user's timezone offset (in minutes) as returned by JS Date.getTimezoneOffset().
  /// Used to interpret availability in the user's local time.
  timezoneOffsetMin Int @default(0)
}

model Appointment {
  id          String            @id @default(uuid())
  clientId    String
  businessId  String
  startAt     DateTime
  durationMin Int
  status      AppointmentStatus @default(BOOKED)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  client   User @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  business User @relation("BusinessAppointments", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, startAt])
  @@index([clientId, startAt])
}

// Weekly working hours for BUSINESS accounts.
// Time is stored as minutes from midnight (0..1439) for easy slot generation.
model BusinessWorkingHour {
  id         String @id @default(uuid())
  businessId String
  dayOfWeek  Int
  startMin   Int
  endMin     Int

  business User @relation("BusinessWorkingHours", fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek])
  @@index([businessId, dayOfWeek])
}

// Optional breaks inside working hours. Multiple breaks per day are allowed.
model BusinessBreak {
  id         String @id @default(uuid())
  businessId String
  dayOfWeek  Int
  startMin   Int
  endMin     Int

  business User @relation("BusinessBreaks", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, dayOfWeek])
}
